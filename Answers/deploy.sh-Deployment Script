#!/bin/bash

# MERN Stack Deployment Script
# This script helps automate the deployment process

set -e  # Exit on error

echo "ðŸš€ MERN Stack Deployment Script"
echo "================================"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if git is installed
if ! command -v git &> /dev/null; then
    print_error "Git is not installed. Please install git first."
    exit 1
fi

# Check for uncommitted changes
if [[ -n $(git status -s) ]]; then
    print_warning "You have uncommitted changes."
    read -p "Do you want to commit them now? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git add .
        read -p "Enter commit message: " commit_msg
        git commit -m "$commit_msg"
    fi
fi

# Check current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)
print_info "Current branch: $current_branch"

# Ask which environment to deploy to
echo ""
echo "Select deployment environment:"
echo "1) Development (develop branch)"
echo "2) Production (main branch)"
read -p "Enter choice (1 or 2): " env_choice

case $env_choice in
    1)
        target_branch="develop"
        print_info "Deploying to Development environment"
        ;;
    2)
        target_branch="main"
        print_warning "Deploying to Production environment"
        read -p "Are you sure? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_info "Deployment cancelled"
            exit 0
        fi
        ;;
    *)
        print_error "Invalid choice"
        exit 1
        ;;
esac

# Switch to target branch
if [ "$current_branch" != "$target_branch" ]; then
    print_info "Switching to $target_branch branch..."
    git checkout $target_branch
    git pull origin $target_branch
fi

# Run tests
echo ""
print_info "Running tests..."

# Backend tests
if [ -d "backend" ]; then
    print_info "Testing backend..."
    cd backend
    if [ -f "package.json" ]; then
        npm test || {
            print_error "Backend tests failed"
            exit 1
        }
    fi
    cd ..
fi

# Frontend tests
if [ -d "frontend" ]; then
    print_info "Testing frontend..."
    cd frontend
    if [ -f "package.json" ]; then
        npm test -- --watchAll=false || {
            print_error "Frontend tests failed"
            exit 1
        }
    fi
    cd ..
fi

print_info "All tests passed âœ“"

# Push to remote
echo ""
print_info "Pushing to remote repository..."
git push origin $target_branch

print_info "Code pushed successfully âœ“"

# CI/CD will handle the rest
echo ""
print_info "âœ… Deployment initiated!"
print_info "GitHub Actions will now:"
print_info "  1. Run linting and tests"
print_info "  2. Build the application"
print_info "  3. Deploy to hosting platforms"
echo ""
print_info "Check GitHub Actions for deployment status:"
print_info "https://github.com/$(git config remote.origin.url | sed 's/.*github.com[:/]\(.*\)\.git/\1/')/actions"
echo ""
print_info "ðŸŽ‰ Done!"
